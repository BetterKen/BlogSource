---
title: TCP协议
date: 2020-04-11 21:01:00
tags:
    - 网络
    - TCP
categories:
    - 基础
    - 网络
---

## 1 TCP三次握手

### 1.1 握手过程



![](http://base422.oss-cn-beijing.aliyuncs.com/tcpws.png)



## 2 TCP四次断开

### 2.1 断开过程

![](http://base422.oss-cn-beijing.aliyuncs.com/nettcpdk.png)

### 2.2 为何一定要等 2MSL

如果不等，释放的端口可能会重连刚断开的服务器端口，这样依然存活在网络里的老的 TCP 报文可能与新 TCP 连接报文冲突，造成数据冲突，为避免此种情况，**需要耐心等待网络老的 TCP 连接的活跃报文全部死翘翘，2MSL 时间可以满足这个需求**（尽管非常保守）！



## 3 TCP如何保证传输可靠性

- **数据包校验**：目的是检测数据在传输过程中的任何变化，若校验出包有错，则丢弃报文段并且不给出响应，这时 TCP 发送数据端超时后会重发数据。
- **对失序数据包重排序**：既然 TCP 报文段作为 IP 数据报来传输，而 IP 数据报的到达可能会失序，因此 TC P报文段的到达也可能会失序。TCP 将对失序数据进行重新排序，然后才交给应用层。
- **丢弃重复数据**：对于重复数据，能够丢弃重复数据。
- **应答机制**：当 TCP 收到发自 TCP 连接另一端的数据，它将发送一个确认。这个确认不是立即发送，通常将推迟几分之一秒。
- **超时重发**：当 TCP 发出一个段后，它启动一个定时器，等待目的端确认收到这个报文段。如果不能及时收到一个确认，将重发这个报文段。
- **流量控制**：TCP 连接的每一方都有固定大小的缓冲空间。TCP 的接收端只允许另一端发送接收端缓冲区所能接纳的数据，这可以防止较快主机致使较慢主机的缓冲区溢出，这就是流量控制。TCP 使用的流量控制协议是可变大小的**滑动窗口协议**。

## 4 滑动窗口

滑动窗口协议，是传输层进行流控的一种措施，**接收方通过通告发送方自己的窗口大小**，从而控制发送方的发送速度，从而达到**防止发送方发送速度过快而导致自己被淹没的目的**。

**TCP 的滑动窗口解决了端到端的流量控制问题，允许接受方对传输进行限制，直到它拥有足够的缓冲空间来容纳更多的数据**



## 5 重传机制

TCP 数据传输的过程，和 MQ Broker 投递消息给 Consumer 是一样的，只**有在 Consumer Ack 确认消息已经消费，该消息才不会再被投递给 Consumer** 。

- **重传时间RTO应略大于RTT**
- **重传次数限制为3次**



## 6 TCP堵塞

解决方法:

- **慢开始**:由小到大逐渐增加拥塞窗口的大小
- **拥塞避免**:即每经过一个往返时间 RTT 就把发送方的拥塞窗口 cwnd 加 1 ，而不是加倍，这样拥塞窗口按线性规律缓慢增长
- **快重传**:接收方在收到一个失序的报文段后就立即发出重复确认（为的是使发送方及早知道有报文段没有到达对方），而不要等到自己发送数据时捎带确认
- **快恢复**:不执行慢开始算法，而是将 cwnd 设置为原来的一半大小，然后执行拥塞避免算法。




